<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
    <meta name="theme-color" content="#FDFBF7">
    <title>Tra Cứu Bàn Tiệc Cưới - Huy Hoàng & Hoa Trần</title>
    <link rel="icon" href="Logo.ico" type="image/x-icon">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts: Playfair (Tiêu đề), Great Vibes (Tên cưới), Inter (Văn bản) -->
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Playfair+Display:ital,wght@0,300;0,600;1,600&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Firebase (chỉ dùng khi đã tạo firebase-config.js từ firebase-config.example.js) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-left: env(safe-area-inset-left, 0px);
            --safe-right: env(safe-area-inset-right, 0px);
            --touch-min: 44px;
            --gold: #C5A059;
        }
        * { -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBF7;
            background-image: radial-gradient(circle, #EAE1D3 1px, transparent 1px);
            background-size: 14px 14px;
            color: #333;
            padding-left: var(--safe-left);
            padding-right: var(--safe-right);
            padding-bottom: var(--safe-bottom);
            overflow-x: hidden;
        }
        h1, .wedding-font { font-family: 'Playfair Display', serif; }
        .handwriting { font-family: 'Great Vibes', cursive; }

        /* Responsive: CHỈ mobile (≤640px) — desktop giữ nguyên như cũ */
        @media (max-width: 640px) {
            body { font-size: 15px; }
            header .header-title { font-size: 1.5rem !important; }
            header .handwriting { font-size: 1.75rem !important; white-space: nowrap; }
            .map-container { max-width: 100%; padding: 0 8px; }
            .table-node { 
                min-width: 32px; min-height: 32px; 
                font-size: 10px; 
            }
            .stage span:first-child { font-size: 0.7rem !important; }
            .bar-area { font-size: 8px; }
        }

        /* Sơ đồ */
        .map-container {
            position: relative; width: 100%; max-width: 500px; aspect-ratio: 3 / 4;
            margin: 0 auto; background-color: #ffffff; border: 1px solid #e5e7eb;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); border-radius: 12px; overflow: hidden;
            touch-action: pan-x pan-y;
        }

        /* Bàn tiệc - touch friendly */
        .table-node {
            position: absolute; width: 7%; min-width: 28px; min-height: 28px; aspect-ratio: 1 / 1; border-radius: 50%;
            background-color: #ffffff; border: 1.5px solid #4b5563;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: 600; color: #374151;
            transform: translate(-50%, -50%); cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .table-node:hover { background-color: #f3f4f6; transform: translate(-50%, -50%) scale(1.1); }
        @media (hover: none) {
            .table-node:active { background-color: #f3f4f6; transform: translate(-50%, -50%) scale(1.08); }
        }
        
        /* Bàn phát sáng */
        .table-node.glow {
            background-color: #fef08a; border-color: #eab308; color: #854d0e;
            box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7);
            animation: pulse-glow 1.5s infinite; z-index: 20;
        }
        @keyframes pulse-glow {
            0% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); }
            70% { transform: translate(-50%, -50%) scale(1.15); box-shadow: 0 0 0 15px rgba(234, 179, 8, 0); }
            100% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); }
        }

        /* Kiến trúc sơ đồ */
        .stage {
            position: absolute; top: 5%; left: 50%; transform: translateX(-50%);
            width: 50%; height: 8%; border: 1.5px solid #374151;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background-color: #fff; z-index: 10;
        }
        .aisle {
            position: absolute; top: 13%; bottom: 15%; left: 50%; transform: translateX(-50%);
            width: 8%; border-left: 1.5px solid #374151; border-right: 1.5px solid #374151;
            background-color: #fafafa;
        }
        .bar-area {
            position: absolute; border: 1.5px solid #374151; background-color: #fff;
            font-size: 9px; font-weight: bold; display: flex; align-items: center; justify-content: center;
            width: 7%; height: 4%; transform: translate(-50%, -50%);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        
        /* List khách */
        .guest-item { transition: background 0.2s; min-height: var(--touch-min); }
        .guest-item:hover { background-color: #fef9c3; cursor: pointer; }
        @media (hover: none) { .guest-item:active { background-color: #fef9c3; } }
        
        /* Admin Tabs */
        .admin-tab-active { border-bottom: 2px solid #2563eb; color: #1d4ed8; font-weight: 600; }
        .admin-tab-inactive { color: #6b7280; font-weight: 500; }
        .admin-tab-inactive:hover { color: #374151; }

        /* Modal & Settings: tối ưu mobile */
        @media (max-width: 640px) {
            #tableModal > div { max-width: min(360px, 90vw); margin: 0 16px; }
            #settingsModal > div { 
                max-height: 85vh; 
                max-width: 95vw; 
                padding: 1rem;
                padding-top: max(1rem, var(--safe-top));
            }
            #settingsModal .flex.gap-2 button { min-height: var(--touch-min); }
        }

        /* Sơ đồ chỉnh sửa - kéo thả bàn */
        .map-edit-container {
            position: relative; width: 100%; aspect-ratio: 3 / 4; max-height: 220px;
            background: #fff; border: 1px solid #e5e7eb; border-radius: 10px;
            overflow: hidden; touch-action: none; user-select: none;
        }
        .map-edit-container .stage, .map-edit-container .aisle, .map-edit-container .bar-area { pointer-events: none; }
        .table-node-draggable {
            cursor: grab; z-index: 15;
        }
        .table-node-draggable:active { cursor: grabbing; }
        .table-node-draggable.dragging { z-index: 25; opacity: 0.95; }

        /* Hiệu ứng bụi vàng (Gold Dust) */
        .gold-dust {
            position: absolute;
            background-color: var(--gold);
            border-radius: 50%;
            opacity: 0;
            pointer-events: none;
            animation: floatUp var(--duration) ease-in-out infinite;
            animation-delay: var(--delay);
            box-shadow: 0 0 6px 1px rgba(197, 160, 89, 0.5);
        }
        @keyframes floatUp {
            0% { opacity: 0; transform: translateY(110vh) translateX(0) scale(0.5); }
            20% { opacity: 0.6; }
            80% { opacity: 0.4; }
            100% { opacity: 0; transform: translateY(-10vh) translateX(var(--drift)) scale(1.2); }
        }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col items-center pb-12 relative" style="padding-top: var(--safe-top, 0);">

    <!-- Container chứa hiệu ứng bụi vàng -->
    <div id="dust-container" class="fixed inset-0 pointer-events-none z-50 overflow-hidden"></div>

    <!-- Nút Setting ẩn góc phải -->
    <button type="button" onclick="openSettings()" class="absolute p-3 text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-400 rounded-full" style="top: max(1rem, var(--safe-top)); right: max(1rem, var(--safe-right)); min-width: var(--touch-min); min-height: var(--touch-min);">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
    </button>

    <!-- Header — desktop như cũ, mobile tối ưu trong @media -->
    <header class="w-full text-center py-6 sm:py-8 px-4">
        <p class="text-[10px] uppercase tracking-[0.3em] mb-2" style="color: #A59573;">Trân trọng kính mời tới dự</p>
        <h1 class="wedding-font text-xl sm:text-2xl font-light uppercase tracking-[0.2em] header-title" style="color: #2C3135;">Lễ Thành Hôn</h1>
        <div class="flex items-center justify-center gap-3 my-4">
            <span class="flex-1 max-w-[60px] sm:max-w-[80px] h-[1px] opacity-70" style="background-color: #C5A059;"></span>
            <svg class="w-4 h-4 opacity-70 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" xmlns="http://www.w3.org/2000/svg" style="color: #C5A059;"><path d="M12 2l2.4 7.4h7.6l-6 4.6 2.3 7.4-6-4.6-6 4.6 2.3-7.4-6-4.6h7.6z"/></svg>
            <span class="flex-1 max-w-[60px] sm:max-w-[80px] h-[1px] opacity-70" style="background-color: #C5A059;"></span>
        </div>
        <h2 class="handwriting text-4xl sm:text-[3.5rem] mt-1" style="color: #C5A059; text-shadow: 0 2px 8px rgba(0,0,0,0.08);">Huy Hoàng & Hoa Trần</h2>
    </header>

    <!-- Khu vực Tìm kiếm — desktop max-w-md như cũ -->
    <section class="w-full max-w-md px-4 sm:px-6 mb-6 sm:mb-8 relative z-30 min-h-[140px]">
        
        <!-- STEP 1: Chọn Nhóm -->
        <div id="step1_GroupSelect" class="transition-all duration-300">
            <p class="text-center font-medium mb-4 text-sm uppercase tracking-wider" style="color: #8B7E66;">Bạn là khách mời của ai?</p>
            <div class="grid grid-cols-1 gap-3">
                <button type="button" onclick="selectGroup('Chú Rể')" class="w-full py-4 sm:py-3 bg-white border border-gray-300 rounded-xl shadow-sm text-gray-700 font-medium hover:bg-yellow-50 hover:border-yellow-400 active:bg-yellow-100 transition flex justify-between items-center px-4 sm:px-6 min-h-[var(--touch-min)]">
                    <span>Khách mời Chú Rể</span>
                    <svg class="h-5 w-5 text-gray-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
                <button type="button" onclick="selectGroup('Cô Dâu')" class="w-full py-4 sm:py-3 bg-white border border-gray-300 rounded-xl shadow-sm text-gray-700 font-medium hover:bg-yellow-50 hover:border-yellow-400 active:bg-yellow-100 transition flex justify-between items-center px-4 sm:px-6 min-h-[var(--touch-min)]">
                    <span>Khách mời Cô Dâu</span>
                    <svg class="h-5 w-5 text-gray-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
                <button type="button" onclick="selectGroup('Mẹ Thủy')" class="w-full py-4 sm:py-3 bg-white border border-gray-300 rounded-xl shadow-sm text-gray-700 font-medium hover:bg-yellow-50 hover:border-yellow-400 active:bg-yellow-100 transition flex justify-between items-center px-4 sm:px-6 min-h-[var(--touch-min)]">
                    <span>Khách mời Mẹ Thủy</span>
                    <svg class="h-5 w-5 text-gray-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
        </div>

        <!-- STEP 2: Chọn Khách -->
        <div id="step2_GuestSelect" class="hidden transition-all duration-300">
            <div class="flex items-center mb-3">
                <button type="button" onclick="backToGroups()" class="text-gray-500 hover:text-gray-800 active:text-gray-900 flex items-center mr-3 py-2 pr-2 -ml-2 min-h-[var(--touch-min)] items-center">
                    <svg class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    Quay lại
                </button>
                <h3 id="selectedGroupTitle" class="font-semibold text-gray-800 flex-1 text-center pr-8">Khách Chú Rể</h3>
            </div>
            
            <div class="relative bg-white border border-gray-300 rounded-xl shadow-sm overflow-hidden flex flex-col min-h-[200px] h-[40vh] max-h-[280px]">
                <div class="p-2 border-b flex-shrink-0">
                    <input type="text" id="guestSearchInput" placeholder="Gõ tên để tìm nhanh..." class="w-full px-3 py-2.5 sm:py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-yellow-500 text-base sm:text-sm" autocomplete="off">
                </div>
                <ul id="guestListOptions" class="overflow-y-auto flex-1 p-2 space-y-1">
                    <!-- Danh sách khách render ở đây -->
                </ul>
            </div>
            <div id="searchResultText" class="text-center mt-2 text-sm text-green-600 font-medium h-5"></div>
        </div>
    </section>

    <!-- Map Section — desktop như cũ -->
    <section class="w-full px-3 sm:px-4 mb-8 sm:mb-10">
        <div class="map-container" id="mapContainer">
            <!-- Stage & Aisle -->
            <div class="stage">
                <span class="font-bold text-sm">Sân Khấu</span>
                <span class="text-[9px] text-gray-600">Sảnh Diamond</span>
            </div>
            <div class="aisle"></div>

            <!-- Bars -->
            <div class="bar-area" style="top: 45%; left: 7%;">BAR</div>
            <div class="bar-area" style="top: 55%; left: 93%;">BAR</div>
            <!-- Bàn render qua JS -->
        </div>
    </section>

    <!-- Modal hiển thị Tên Bàn (Chỉ hiện tên bàn) -->
    <div id="tableModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300 backdrop-blur-sm" style="padding: max(1rem, var(--safe-top)) max(1rem, var(--safe-right)) max(1rem, var(--safe-bottom)) max(1rem, var(--safe-left));">
        <div class="bg-white rounded-2xl w-full max-w-[360px] overflow-hidden shadow-2xl transform scale-95 transition-transform duration-300 text-center relative p-8 ring-2 ring-black/5" style="box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25), 0 0 0 1px rgba(0,0,0,0.05);">
            <button type="button" id="closeTableModalBtn" class="absolute p-2 text-gray-400 hover:text-gray-800 rounded-full min-w-[var(--touch-min)] min-h-[var(--touch-min)] flex items-center justify-center" style="top: 0.5rem; right: 0.5rem;">
                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <div class="w-28 h-28 sm:w-32 sm:h-32 rounded-full flex items-center justify-center mx-auto mb-4 flex-shrink-0 shadow-lg" style="background-color: #223150; box-shadow: 0 10px 25px -5px rgba(34, 49, 80, 0.4), 0 0 0 3px rgba(255,255,255,0.8);">
                <img src="Logo.ico" alt="Logo" class="h-20 w-20 sm:h-24 sm:w-24 object-contain" />
            </div>
            <h3 class="wedding-font text-3xl sm:text-4xl font-bold text-gray-800 mb-1" id="modalOnlyTableTitle">Bàn số 1</h3>
            <p class="text-sm text-gray-500">Sảnh Diamond</p>
            <p class="text-xs text-gray-500 mt-2 pt-2 border-t border-gray-100">Khách mời</p>
            <p class="text-sm font-medium text-gray-700 mt-0.5" id="modalGuestNames">—</p>
        </div>
    </div>

    <!-- Modal Cài đặt (Settings) -->
    <div id="settingsModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-3 sm:p-4 z-50 hidden" style="padding: max(0.75rem, var(--safe-top)) max(0.75rem, var(--safe-right)) max(0.75rem, var(--safe-bottom)) max(0.75rem, var(--safe-left));">
        <div class="bg-white rounded-xl w-full max-w-lg p-4 sm:p-6 shadow-2xl relative flex flex-col max-h-[90vh] overflow-hidden">
            <button type="button" onclick="closeSettings()" class="absolute p-2 text-gray-500 hover:text-gray-800 rounded-full min-w-[var(--touch-min)] min-h-[var(--touch-min)] flex items-center justify-center" style="top: max(0.5rem, var(--safe-top)); right: 1rem;">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h2 class="text-2xl font-bold mb-4">Quản lý Danh Sách</h2>

            <!-- Khu vực Login -->
            <div id="loginArea">
                <p class="mb-2 text-sm text-gray-600">Vui lòng nhập mật khẩu để tiếp tục:</p>
                <input type="password" id="adminPass" class="w-full border p-2 rounded mb-3" placeholder="Mật khẩu...">
                <button onclick="checkPass()" class="w-full bg-blue-600 text-white py-2 rounded font-medium hover:bg-blue-700">Đăng Nhập</button>
                <p id="loginError" class="text-red-500 text-sm mt-2 hidden">Sai mật khẩu!</p>
            </div>

            <!-- Khu vực Admin (Sau khi login) -->
            <div id="adminArea" class="hidden flex-1 flex flex-col min-h-0 w-full">
                <!-- Tabs Header -->
                <div class="flex border-b mb-4">
                    <button id="tabBtn1" onclick="switchAdminTab('byTable')" class="flex-1 py-2 text-center text-xs sm:text-sm admin-tab-active">Khách</button>
                    <button id="tabBtn2" onclick="switchAdminTab('byExcel')" class="flex-1 py-2 text-center text-xs sm:text-sm admin-tab-inactive">Excel</button>
                    <button id="tabBtn3" onclick="switchAdminTab('tables')" class="flex-1 py-2 text-center text-xs sm:text-sm admin-tab-inactive">Sơ đồ bàn</button>
                </div>

                <!-- Tab 1: Quản lý theo bàn -->
                <div id="tabContentByTable" class="flex-1 flex flex-col min-h-0">
                    <!-- Form Thêm / Sửa -->
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mb-4 shadow-sm">
                        <h4 class="text-sm font-semibold mb-2" id="adminFormTitle">Thêm Khách Mới</h4>
                        <div class="flex flex-col gap-2">
                            <input type="hidden" id="adminEditGuestId" value="">
                            <input type="text" id="adminNewGuestName" placeholder="Tên khách mời..." class="w-full border border-gray-300 rounded p-2 text-sm focus:outline-blue-500 focus:border-blue-500">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs text-gray-500 mb-0.5">Nhóm</label>
                                    <select id="adminNewGuestGroup" class="w-full min-w-0 border border-gray-300 rounded p-2 text-sm focus:outline-blue-500 focus:border-blue-500">
                                        <option value="Chú Rể">Nhóm Chú Rể</option>
                                        <option value="Cô Dâu">Nhóm Cô Dâu</option>
                                        <option value="Mẹ Thủy">Nhóm Mẹ Thủy</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500 mb-0.5">Số bàn</label>
                                    <input type="text" id="adminNewGuestTable" placeholder="VD: 1, 2" class="w-full border border-gray-300 rounded p-2 text-sm focus:outline-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            <div class="flex gap-2 flex-wrap">
                                <button id="adminSaveBtn" onclick="adminSaveGuest()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-blue-700 whitespace-nowrap shadow-sm transition">Thêm</button>
                                <button id="adminCancelBtn" onclick="adminCancelEdit()" class="hidden bg-gray-300 text-gray-700 px-3 py-2 rounded text-sm font-medium hover:bg-gray-400 whitespace-nowrap shadow-sm transition">Hủy</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Danh sách tất cả -->
                    <div class="flex-1 flex flex-col min-h-0">
                        <div class="flex justify-between items-end mb-2">
                            <h4 class="text-sm font-semibold text-gray-800 flex items-center gap-2">
                                Danh sách tất cả khách
                                <span id="adminTotalGuestCount" class="bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full text-xs font-medium">0</span>
                            </h4>
                            <input type="text" id="adminSearchList" oninput="renderAdminAllGuests()" placeholder="Tìm nhanh..." class="border border-gray-300 rounded p-1.5 text-xs w-32 focus:outline-blue-500">
                        </div>
                        <div class="flex-1 overflow-y-auto border border-gray-200 rounded-lg bg-white min-h-[150px]">
                            <ul id="adminAllGuestList" class="divide-y divide-gray-100">
                                <!-- Load JS -->
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Tab 2: Nhập từ Excel -->
                <div id="tabContentByExcel" class="hidden flex-1 flex flex-col min-h-0">
                    <div class="bg-blue-50 text-blue-800 text-xs p-3 rounded-lg mb-3">
                        <b>Hướng dẫn nhập danh sách hàng loạt:</b><br>
                        1. Nhập mỗi dòng theo định dạng: <b>Tên Khách | Số Bàn | Nhóm</b>.<br>
                        <i>(Ví dụ: Gia đình Bác Hai | 1 | Chú Rể)</i><br>
                        2. Cột Nhóm: Ghi <b>Chú Rể</b>, <b>Cô Dâu</b>, hoặc <b>Mẹ Thủy</b>.<br>
                        3. Bạn có thể gõ trực tiếp hoặc Copy & Paste vào ô bên dưới.
                    </div>
                    <textarea id="excelPasteArea" class="w-full flex-1 border border-gray-300 rounded-lg p-2 text-sm font-mono whitespace-pre mb-3 min-h-[120px]" placeholder="Nhập dữ liệu vào đây...&#10;Ví dụ:&#10;Gia đình Bác Hai | 1 | Chú Rể&#10;Đồng nghiệp Công ty A | 2, 3 | Chú Rể"></textarea>
                    <div class="flex gap-2">
                        <button type="button" onclick="parsePastedData()" class="flex-1 bg-green-600 text-white py-2 rounded font-medium hover:bg-green-700">Lưu Dữ Liệu</button>
                    </div>
                </div>

                <!-- Tab 3: Sơ đồ bàn - Thêm / Sắp xếp vị trí bàn -->
                <div id="tabContentTables" class="hidden flex-1 flex flex-col min-h-0 overflow-hidden">
                    <div class="bg-amber-50 text-amber-900 text-xs p-3 rounded-lg mb-2">
                        <b>Kéo thả bàn</b> trên sơ đồ bên dưới để sắp xếp vị trí. Thả chuột/tay là lưu tự động.
                    </div>
                    <!-- Sơ đồ thu nhỏ - kéo thả -->
                    <div class="mb-3 flex-shrink-0">
                        <div id="mapEditContainer" class="map-edit-container map-container mx-auto">
                            <!-- Stage, aisle, bars + bàn được render bằng JS -->
                        </div>
                    </div>
                    <!-- Form thêm bàn -->
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mb-3 shadow-sm flex-shrink-0">
                        <h4 class="text-sm font-semibold mb-2">Thêm bàn mới</h4>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 items-end">
                            <div>
                                <label class="text-xs text-gray-600 block mb-0.5">Số bàn</label>
                                <input type="number" id="newTableId" min="1" placeholder="Tự động" class="w-full border border-gray-300 rounded p-2 text-sm focus:outline-blue-500">
                            </div>
                            <div>
                                <label class="text-xs text-gray-600 block mb-0.5">Vị trí X (%)</label>
                                <input type="number" id="newTableX" min="0" max="100" value="50" class="w-full border border-gray-300 rounded p-2 text-sm focus:outline-blue-500">
                            </div>
                            <div>
                                <label class="text-xs text-gray-600 block mb-0.5">Vị trí Y (%)</label>
                                <input type="number" id="newTableY" min="0" max="100" value="50" class="w-full border border-gray-300 rounded p-2 text-sm focus:outline-blue-500">
                            </div>
                            <div>
                                <button type="button" onclick="addNewTable()" class="w-full bg-amber-600 text-white py-2 rounded text-sm font-medium hover:bg-amber-700">Thêm bàn</button>
                            </div>
                        </div>
                    </div>
                    <!-- Danh sách bàn -->
                    <div class="flex-1 flex flex-col min-h-0">
                        <h4 class="text-sm font-semibold text-gray-800 mb-2 flex items-center gap-2">
                            Danh sách bàn
                            <span id="adminTableCount" class="bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full text-xs font-medium">0</span>
                        </h4>
                        <div class="flex-1 overflow-y-auto border border-gray-200 rounded-lg bg-white min-h-[180px]">
                            <ul id="adminTableList" class="divide-y divide-gray-100 p-1">
                                <!-- render JS -->
                            </ul>
                        </div>
                        <p class="mt-2">
                            <button type="button" onclick="resetTablePositions()" class="text-amber-600 text-xs hover:underline">Khôi phục 45 bàn mặc định</button>
                        </p>
                    </div>
                </div>

                <div class="mt-4 pt-3 border-t border-gray-200 flex justify-between items-center flex-wrap gap-2">
                    <p id="saveMsg" class="text-green-600 text-sm font-medium flex-1 min-w-0"></p>
                    <div class="flex gap-2 items-center flex-shrink-0">
                        <span id="firebaseStatus" class="text-xs text-gray-400 hidden sm:inline">Firebase: đã kết nối</span>
                        <button type="button" onclick="clearGuestsKeepTables()" class="p-2 rounded-full text-amber-600 hover:bg-amber-50 active:bg-amber-100 transition" title="Xóa toàn bộ khách (chỉ giữ sơ đồ bàn)" aria-label="Xóa toàn bộ khách">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === FIREBASE (chỉ dùng khi đã cấu hình trong firebase-config.js) ===
        var firebaseDb = null;
        var useFirebase = false;
        if (typeof firebaseConfig !== 'undefined' && typeof firebase !== 'undefined' &&
            firebaseConfig.apiKey && firebaseConfig.apiKey !== 'YOUR_API_KEY') {
            try {
                firebase.initializeApp(firebaseConfig);
                firebaseDb = firebase.firestore();
                useFirebase = true;
            } catch (e) { console.warn('Firebase init failed', e); }
        }

        function loadFromFirebase() {
            if (!firebaseDb) return Promise.resolve();
            return firebaseDb.collection('weddingMap').doc('data').get()
                .then(function(doc) {
                    if (doc.exists) {
                        var d = doc.data();
                        if (d.guests && Array.isArray(d.guests)) {
                            guests = d.guests;
                            localStorage.setItem('weddingGuests', JSON.stringify(guests));
                        }
                        if (d.tablePositions && Array.isArray(d.tablePositions)) {
                            tablePositions = d.tablePositions;
                            localStorage.setItem('weddingTablePositions', JSON.stringify(tablePositions));
                        }
                    }
                })
                .catch(function(err) { console.warn('Firebase load failed', err); });
        }

        function saveGuestsToFirebase() {
            if (!firebaseDb) return;
            firebaseDb.collection('weddingMap').doc('data').set(
                { guests: guests, tablePositions: tablePositions },
                { merge: true }
            ).then(function() { if (typeof console !== 'undefined' && console.log) console.log('[Firebase] Đã lưu khách lên cloud.'); })
            .catch(function(err) { console.warn('Firebase save guests failed', err); });
        }

        function saveTablesToFirebase() {
            if (!firebaseDb) return;
            firebaseDb.collection('weddingMap').doc('data').set(
                { tablePositions: tablePositions },
                { merge: true }
            ).then(function() { if (typeof console !== 'undefined' && console.log) console.log('[Firebase] Đã lưu sơ đồ bàn lên cloud.'); })
            .catch(function(err) { console.warn('Firebase save tables failed', err); });
        }

        // 1. SƠ ĐỒ BÀN (động, lưu localStorage + Firebase nếu có)
        const defaultTablePositions = [
            { id: 1, x: 14, y: 22 }, { id: 2, x: 14, y: 30 }, { id: 3, x: 14, y: 38 },
            { id: 4, x: 14, y: 52 }, { id: 5, x: 14, y: 60 }, { id: 6, x: 14, y: 68 }, { id: 7, x: 14, y: 76 },
            { id: 8, x: 26, y: 26 }, { id: 9, x: 26, y: 34 }, { id: 10, x: 26, y: 42 },
            { id: 11, x: 26, y: 52 }, { id: 12, x: 26, y: 60 }, { id: 13, x: 26, y: 68 }, { id: 14, x: 26, y: 76 },
            { id: 15, x: 38, y: 22 }, { id: 16, x: 38, y: 30 }, { id: 17, x: 38, y: 38 }, { id: 18, x: 38, y: 46 },
            { id: 19, x: 38, y: 54 }, { id: 20, x: 38, y: 62 }, { id: 21, x: 38, y: 70 }, { id: 22, x: 38, y: 78 },
            { id: 23, x: 62, y: 22 }, { id: 24, x: 62, y: 30 }, { id: 25, x: 62, y: 38 }, { id: 26, x: 62, y: 46 },
            { id: 27, x: 62, y: 54 }, { id: 28, x: 62, y: 62 }, { id: 29, x: 62, y: 70 }, { id: 30, x: 62, y: 78 },
            { id: 31, x: 74, y: 26 }, { id: 32, x: 74, y: 34 }, { id: 33, x: 74, y: 42 }, { id: 34, x: 74, y: 50 },
            { id: 35, x: 74, y: 58 }, { id: 36, x: 74, y: 68 }, { id: 37, x: 74, y: 76 },
            { id: 38, x: 86, y: 22 }, { id: 39, x: 86, y: 30 }, { id: 40, x: 86, y: 38 }, { id: 41, x: 86, y: 46 },
            { id: 42, x: 86, y: 54 }, { id: 43, x: 86, y: 64 }, { id: 44, x: 86, y: 72 }, { id: 45, x: 86, y: 80 }
        ];
        let tablePositions = [];

        function loadTablePositions() {
            const saved = localStorage.getItem('weddingTablePositions');
            if (saved) {
                try {
                    tablePositions = JSON.parse(saved);
                    if (!Array.isArray(tablePositions) || tablePositions.length === 0) tablePositions = [...defaultTablePositions];
                } catch (e) {
                    tablePositions = [...defaultTablePositions];
                }
            } else {
                tablePositions = [...defaultTablePositions];
            }
        }

        function saveTablePositions() {
            localStorage.setItem('weddingTablePositions', JSON.stringify(tablePositions));
            if (useFirebase) saveTablesToFirebase();
        }

        // 2. DỮ LIỆU KHÁCH MỜI
        let guests = [];
        let currentGroupFilter = '';

        // Hàm tạo ID ngẫu nhiên để xóa khách chính xác
        function generateId() {
            return Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        }

        function initMockData() {
            guests = [
                { id: generateId(), name: 'Gia đình Bác Hai', table: '1', group: 'Chú Rể' },
                { id: generateId(), name: 'Đồng nghiệp Công ty A', table: '2, 3', group: 'Chú Rể' },
                { id: generateId(), name: 'Bạn Đại học', table: '15, 16, 17', group: 'Cô Dâu' },
                { id: generateId(), name: 'Gia đình Dì Ba', table: '18', group: 'Cô Dâu' },
                { id: generateId(), name: 'Hội Bạn Cấp 3', table: '40', group: 'Mẹ Thủy' },
                { id: generateId(), name: 'Hàng xóm', table: '41, 42', group: 'Mẹ Thủy' }
            ];
            // Tự sinh thêm dữ liệu để test thanh cuộn
            for(let i=4; i<=14; i++) guests.push({id: generateId(), name: `Khách của Chú Rể ${i}`, table: `${i}`, group: 'Chú Rể'});
            for(let i=19; i<=30; i++) guests.push({id: generateId(), name: `Khách của Cô Dâu ${i}`, table: `${i}`, group: 'Cô Dâu'});
        }

        // Load dữ liệu từ LocalStorage hoặc Firebase (nếu đã cấu hình)
        // Mặc định danh sách khách trống (mới tinh) — bạn nhập sau, data sẽ lên cloud
        function loadData() {
            var saved = localStorage.getItem('weddingGuests');
            if (saved) {
                guests = JSON.parse(saved);
            } else {
                guests = [];
            }
        }

        // 3. RENDER GIAO DIỆN
        const mapContainer = document.getElementById('mapContainer');
        function renderTables() {
            mapContainer.innerHTML = `
                <div class="stage"><span class="font-bold text-sm">Sân Khấu</span><span class="text-[9px] text-gray-600">Sảnh Diamond</span></div>
                <div class="aisle"></div>
                <div class="bar-area" style="top: 45%; left: 7%;">BAR</div>
                <div class="bar-area" style="top: 55%; left: 93%;">BAR</div>
            `;
            tablePositions.forEach(pos => {
                const div = document.createElement('div');
                div.className = 'table-node'; div.id = `table-${pos.id}`;
                div.style.left = `${pos.x}%`; div.style.top = `${pos.y}%`;
                div.innerText = pos.id;
                div.addEventListener('click', () => openTableModal(pos.id));
                mapContainer.appendChild(div);
            });
        }

        // 4. LUỒNG TÌM KIẾM
        const step1 = document.getElementById('step1_GroupSelect');
        const step2 = document.getElementById('step2_GuestSelect');
        const listContainer = document.getElementById('guestListOptions');
        const searchInput = document.getElementById('guestSearchInput');
        const searchMsg = document.getElementById('searchResultText');

        function removeDiacritics(str) {
            return str ? str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/đ/g, "d").replace(/Đ/g, "D").toLowerCase() : "";
        }

        function selectGroup(group) {
            currentGroupFilter = group;
            document.getElementById('selectedGroupTitle').innerText = `Khách ${group}`;
            step1.classList.add('hidden');
            step2.classList.remove('hidden');
            searchInput.value = '';
            searchMsg.innerText = '';
            renderGuestList();
        }

        function backToGroups() {
            step2.classList.add('hidden');
            step1.classList.remove('hidden');
            clearHighlights();
        }

        function renderGuestList(filterText = '') {
            listContainer.innerHTML = '';
            const normalizedFilter = removeDiacritics(filterText);
            
            // Lọc theo nhóm và text
            let filtered = guests.filter(g => g.group === currentGroupFilter);
            if (normalizedFilter) {
                filtered = filtered.filter(g => removeDiacritics(g.name).includes(normalizedFilter));
            }

            if (filtered.length === 0) {
                listContainer.innerHTML = `<li class="text-gray-500 text-sm text-center py-4">Không tìm thấy ai.</li>`;
                return;
            }

            filtered.forEach(g => {
                const li = document.createElement('li');
                li.className = 'guest-item px-3 py-2 border-b border-gray-100 rounded text-sm flex justify-between items-center';
                li.innerHTML = `<span class="font-medium text-gray-700">${g.name}</span> <span class="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded-full">Bàn ${g.table}</span>`;
                li.onclick = () => highlightTable(g);
                listContainer.appendChild(li);
            });
        }

        searchInput.addEventListener('input', (e) => {
            renderGuestList(e.target.value);
            clearHighlights();
        });

        function clearHighlights() {
            document.querySelectorAll('.table-node').forEach(t => t.classList.remove('glow'));
        }

        function highlightTable(guest) {
            clearHighlights();
            // Lấy ra tất cả các số bàn từ chuỗi (hỗ trợ "15", "15, 16", "15 & 16"...)
            const tableNumbers = String(guest.table).match(/\d+/g);
            
            if (tableNumbers && tableNumbers.length > 0) {
                tableNumbers.forEach(tId => {
                    const tableEl = document.getElementById(`table-${tId}`);
                    if (tableEl) {
                        tableEl.classList.add('glow');
                    }
                });
                searchMsg.innerHTML = `Đã tìm thấy vị trí bàn của <b>${guest.name}</b>`;
                // Cuộn xuống bản đồ
                document.getElementById('mapContainer').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // 5. MODAL BÀN TIỆC (Chỉ hiện tên bàn)
        const tableModal = document.getElementById('tableModal');
        const tableModalBox = tableModal.querySelector('div');
        
        function openTableModal(tableId) {
            document.getElementById('modalOnlyTableTitle').innerText = `Bàn số ${tableId}`;
            var namesAtTable = guests.filter(function(g) {
                var tables = String(g.table).match(/\d+/g);
                return tables && tables.indexOf(String(tableId)) !== -1;
            }).map(function(g) { return g.name; });
            var guestEl = document.getElementById('modalGuestNames');
            guestEl.innerText = namesAtTable.length > 0 ? namesAtTable.join(', ') : '—';
            tableModal.classList.remove('opacity-0', 'pointer-events-none');
            tableModalBox.classList.remove('scale-95');
        }

        function closeTableModal() {
            tableModal.classList.add('opacity-0', 'pointer-events-none');
            tableModalBox.classList.add('scale-95');
        }
        
        document.getElementById('closeTableModalBtn').addEventListener('click', closeTableModal);
        tableModal.addEventListener('click', (e) => { if (e.target === tableModal) closeTableModal(); });


        // 6. HỆ THỐNG CÀI ĐẶT (ADMIN)
        const settingsModal = document.getElementById('settingsModal');
        const loginArea = document.getElementById('loginArea');
        const adminArea = document.getElementById('adminArea');
        const textarea = document.getElementById('excelPasteArea');

        function openSettings() {
            settingsModal.classList.remove('hidden');
            document.getElementById('adminPass').value = '';
            document.getElementById('loginError').classList.add('hidden');
            document.getElementById('saveMsg').innerText = '';
            
            // Nếu đã có data, hiển thị dưới dạng Text dùng dấu | để dễ copy/sửa lại
            if(guests.length > 0) {
                let text = guests.map(g => `${g.name} | ${g.table} | ${g.group}`).join('\n');
                textarea.value = text;
            }
        }

        function closeSettings() {
            settingsModal.classList.add('hidden');
            loginArea.classList.remove('hidden');
            adminArea.classList.add('hidden');
            adminCancelEdit(); // Reset form nếu đang sửa dở
        }

        function checkPass() {
            const pass = document.getElementById('adminPass').value;
            if (pass === 'huy@123') {
                loginArea.classList.add('hidden');
                adminArea.classList.remove('hidden');
                if (document.getElementById('firebaseStatus')) {
                    document.getElementById('firebaseStatus').classList.toggle('hidden', !useFirebase);
                    document.getElementById('firebaseStatus').classList.toggle('text-green-600', useFirebase);
                }
                switchAdminTab('byTable');
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        // ================= LUỒNG QUẢN LÝ DANH SÁCH =================
        function switchAdminTab(tab) {
            const tab1 = document.getElementById('tabContentByTable');
            const tab2 = document.getElementById('tabContentByExcel');
            const tab3 = document.getElementById('tabContentTables');
            const btn1 = document.getElementById('tabBtn1');
            const btn2 = document.getElementById('tabBtn2');
            const btn3 = document.getElementById('tabBtn3');
            const activeCls = "flex-1 py-2 text-center text-xs sm:text-sm admin-tab-active";
            const inactiveCls = "flex-1 py-2 text-center text-xs sm:text-sm admin-tab-inactive border-b border-transparent";

            tab1.classList.add('hidden'); tab2.classList.add('hidden'); tab3.classList.add('hidden');
            btn1.className = inactiveCls; btn2.className = inactiveCls; btn3.className = inactiveCls;

            if (tab === 'byTable') {
                tab1.classList.remove('hidden');
                btn1.className = activeCls;
                renderAdminAllGuests();
            } else if (tab === 'byExcel') {
                tab2.classList.remove('hidden');
                btn2.className = activeCls;
            } else if (tab === 'tables') {
                tab3.classList.remove('hidden');
                btn3.className = activeCls;
                renderMapEdit();
                renderAdminTableList();
            }
        }

        function renderAdminAllGuests() {
            const listEl = document.getElementById('adminAllGuestList');
            const searchText = removeDiacritics(document.getElementById('adminSearchList').value);
            listEl.innerHTML = '';
            
            // Lọc danh sách nếu có nhập ô tìm kiếm
            let displayGuests = guests;
            if (searchText) {
                displayGuests = guests.filter(g => removeDiacritics(g.name).includes(searchText) || removeDiacritics(g.group).includes(searchText) || String(g.table).includes(searchText));
            }

            document.getElementById('adminTotalGuestCount').innerText = displayGuests.length;

            if(displayGuests.length === 0) {
                listEl.innerHTML = `<li class="text-gray-400 text-sm text-center py-8 italic">Không có dữ liệu.</li>`;
                return;
            }

            // Render danh sách (Đảo ngược để người mới thêm hiện lên đầu)
            [...displayGuests].reverse().forEach(g => {
                const li = document.createElement('li');
                li.className = "flex justify-between items-center p-3 hover:bg-gray-50 transition";
                li.innerHTML = `
                    <div class="flex flex-col">
                        <span class="text-sm font-medium text-gray-800">${g.name}</span>
                        <div class="flex gap-2 mt-1.5">
                            <span class="text-[10px] text-blue-700 bg-blue-100 border border-blue-200 px-1.5 py-0.5 rounded font-medium">${g.group}</span>
                            <span class="text-[10px] text-green-700 bg-green-100 border border-green-200 px-1.5 py-0.5 rounded font-medium">Bàn: ${g.table}</span>
                        </div>
                    </div>
                    <div class="flex gap-1.5">
                        <button onclick="adminEditGuest('${g.id}')" class="text-blue-500 hover:text-blue-700 hover:bg-blue-100 p-1.5 rounded transition" title="Sửa thông tin">
                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                        </button>
                        <button onclick="adminDeleteGuest('${g.id}')" class="text-red-500 hover:text-red-700 hover:bg-red-100 p-1.5 rounded transition" title="Xóa khách này">
                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>
                `;
                listEl.appendChild(li);
            });
        }

        /** Kiểm tra chuỗi số bàn (VD: "1", "1, 2", "15, 16") — chỉ chấp nhận số bàn có trên sơ đồ */
        function validateTableIds(tableStr) {
            const ids = (tableStr.match(/\d+/g) || []).map(s => parseInt(s, 10));
            const validIds = new Set(tablePositions.map(t => t.id));
            const invalidIds = ids.filter(id => !validIds.has(id));
            return invalidIds.length === 0 ? { valid: true } : { valid: false, invalidIds };
        }

        function adminSaveGuest() {
            const idInput = document.getElementById('adminEditGuestId').value;
            const name = document.getElementById('adminNewGuestName').value.trim();
            const group = document.getElementById('adminNewGuestGroup').value;
            const table = document.getElementById('adminNewGuestTable').value.trim();

            if(!name || !table) { alert("Vui lòng nhập Tên và Số bàn!"); return; }

            const tableCheck = validateTableIds(table);
            if (!tableCheck.valid) {
                const list = tablePositions.length ? tablePositions.map(t => t.id).join(', ') : '(chưa có bàn)';
                alert(`Số bàn ${tableCheck.invalidIds.join(', ')} không có trên sơ đồ.\nChỉ chấp nhận các bàn hiện có: ${list}`);
                return;
            }

            if (idInput) {
                // Đang ở trạng thái Sửa (Update)
                const index = guests.findIndex(g => g.id === idInput);
                if (index !== -1) {
                    guests[index].name = name;
                    guests[index].group = group;
                    guests[index].table = table;
                    saveDataToLocal("Đã cập nhật thông tin thành công!");
                }
            } else {
                // Đang ở trạng thái Thêm mới (Add)
                guests.push({ id: generateId(), name, table, group });
                saveDataToLocal("Đã thêm khách thành công!");
            }
            
            adminCancelEdit(); // Reset form
            renderAdminAllGuests(); // Cập nhật danh sách
            if(!step2.classList.contains('hidden')) renderGuestList(searchInput.value); // Cập nhật màn search ngoài
        }

        function adminEditGuest(guestId) {
            const guest = guests.find(g => g.id === guestId);
            if (!guest) return;

            // Đổ dữ liệu lên form
            document.getElementById('adminFormTitle').innerText = "Sửa Thông Tin";
            document.getElementById('adminEditGuestId').value = guest.id;
            document.getElementById('adminNewGuestName').value = guest.name;
            document.getElementById('adminNewGuestGroup').value = guest.group;
            document.getElementById('adminNewGuestTable').value = guest.table;

            // Đổi giao diện nút
            const saveBtn = document.getElementById('adminSaveBtn');
            saveBtn.innerText = "Lưu lại";
            saveBtn.classList.replace('bg-blue-600', 'bg-green-600');
            saveBtn.classList.replace('hover:bg-blue-700', 'hover:bg-green-700');
            
            document.getElementById('adminCancelBtn').classList.remove('hidden');
            
            // Cuộn lên form
            document.getElementById('adminFormTitle').scrollIntoView({ behavior: 'smooth' });
        }

        function adminCancelEdit() {
            // Reset form
            document.getElementById('adminFormTitle').innerText = "Thêm Khách Mới";
            document.getElementById('adminEditGuestId').value = "";
            document.getElementById('adminNewGuestName').value = "";
            document.getElementById('adminNewGuestGroup').value = "Chú Rể";
            document.getElementById('adminNewGuestTable').value = "";

            // Reset nút
            const saveBtn = document.getElementById('adminSaveBtn');
            saveBtn.innerText = "Thêm";
            saveBtn.classList.replace('bg-green-600', 'bg-blue-600');
            saveBtn.classList.replace('hover:bg-green-700', 'hover:bg-blue-700');
            
            document.getElementById('adminCancelBtn').classList.add('hidden');
        }

        function adminDeleteGuest(guestId) {
            if(confirm("Bạn có chắc chắn muốn xóa khách này khỏi sơ đồ không?")) {
                guests = guests.filter(g => g.id !== guestId);
                saveDataToLocal("Đã xóa khách khỏi danh sách!");
                renderAdminAllGuests();
                
                if(!step2.classList.contains('hidden')) renderGuestList(searchInput.value);
            }
        }

        // ================= QUẢN LÝ SƠ ĐỒ BÀN =================
        let draggingTableId = null;
        let dragStartX = 0, dragStartY = 0;

        function renderMapEdit() {
            const container = document.getElementById('mapEditContainer');
            if (!container) return;
            container.innerHTML = `
                <div class="stage"><span class="font-bold text-sm">Sân Khấu</span><span class="text-[9px] text-gray-600">Sảnh Diamond</span></div>
                <div class="aisle"></div>
                <div class="bar-area" style="top: 45%; left: 7%;">BAR</div>
                <div class="bar-area" style="top: 55%; left: 93%;">BAR</div>
            `;
            tablePositions.forEach(pos => {
                const div = document.createElement('div');
                div.className = 'table-node table-node-draggable';
                div.dataset.tableId = pos.id;
                div.style.left = pos.x + '%';
                div.style.top = pos.y + '%';
                div.innerText = pos.id;
                div.addEventListener('mousedown', onEditMapDragStart);
                div.addEventListener('touchstart', onEditMapDragStart, { passive: false });
                container.appendChild(div);
            });
        }

        function getEditMapEventPos(e) {
            const container = document.getElementById('mapEditContainer');
            if (!container) return { x: 50, y: 50 };
            const rect = container.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const x = ((clientX - rect.left) / rect.width) * 100;
            const y = ((clientY - rect.top) / rect.height) * 100;
            return { x: Math.max(0, Math.min(100, x)), y: Math.max(0, Math.min(100, y)) };
        }

        function onEditMapDragStart(e) {
            e.preventDefault();
            const id = parseInt(e.currentTarget.dataset.tableId, 10);
            if (!id) return;
            const pos = getEditMapEventPos(e);
            draggingTableId = id;
            dragStartX = pos.x;
            dragStartY = pos.y;
            e.currentTarget.classList.add('dragging');
            document.addEventListener('mousemove', onEditMapDragMove);
            document.addEventListener('mouseup', onEditMapDragEnd);
            document.addEventListener('touchmove', onEditMapDragMove, { passive: false });
            document.addEventListener('touchend', onEditMapDragEnd);
        }

        function onEditMapDragMove(e) {
            e.preventDefault();
            if (draggingTableId == null) return;
            const pos = getEditMapEventPos(e);
            const t = tablePositions.find(p => p.id === draggingTableId);
            if (t) {
                t.x = Math.round(pos.x * 10) / 10;
                t.y = Math.round(pos.y * 10) / 10;
                const node = document.querySelector(`#mapEditContainer .table-node-draggable[data-table-id="${draggingTableId}"]`);
                if (node) {
                    node.style.left = t.x + '%';
                    node.style.top = t.y + '%';
                }
            }
        }

        function onEditMapDragEnd(e) {
            e.preventDefault();
            if (draggingTableId == null) return;
            const node = document.querySelector(`#mapEditContainer .table-node-draggable[data-table-id="${draggingTableId}"]`);
            if (node) node.classList.remove('dragging');
            document.removeEventListener('mousemove', onEditMapDragMove);
            document.removeEventListener('mouseup', onEditMapDragEnd);
            document.removeEventListener('touchmove', onEditMapDragMove);
            document.removeEventListener('touchend', onEditMapDragEnd);
            saveTablePositions();
            renderTables();
            renderAdminTableList();
            const msgEl = document.getElementById('saveMsg');
            if (msgEl) { msgEl.innerText = 'Đã lưu vị trí bàn.'; setTimeout(() => { msgEl.innerText = ''; }, 2000); }
            draggingTableId = null;
        }

        function addNewTable() {
            let idInput = document.getElementById('newTableId').value.trim();
            const xVal = parseInt(document.getElementById('newTableX').value, 10);
            const yVal = parseInt(document.getElementById('newTableY').value, 10);
            if (isNaN(xVal) || isNaN(yVal)) {
                alert('Vui lòng nhập X và Y hợp lệ (0–100).');
                return;
            }
            const x = Math.max(0, Math.min(100, xVal));
            const y = Math.max(0, Math.min(100, yVal));

            let id;
            if (idInput === '') {
                const maxId = tablePositions.length ? Math.max(...tablePositions.map(t => t.id)) : 0;
                id = maxId + 1;
            } else {
                id = parseInt(idInput, 10);
                if (isNaN(id) || id < 1) {
                    alert('Số bàn phải là số nguyên dương.');
                    return;
                }
                if (tablePositions.some(t => t.id === id)) {
                    alert('Bàn số ' + id + ' đã tồn tại. Hãy chọn số khác hoặc để trống để tự động.');
                    return;
                }
            }

            tablePositions.push({ id, x, y });
            tablePositions.sort((a, b) => a.id - b.id);
            saveTablePositions();
            renderTables();
            renderMapEdit();
            renderAdminTableList();
            document.getElementById('newTableId').value = '';
            document.getElementById('newTableX').value = '50';
            document.getElementById('newTableY').value = '50';
            const msgEl = document.getElementById('saveMsg');
            msgEl.innerText = 'Đã thêm bàn số ' + id + '.';
            setTimeout(() => { msgEl.innerText = ''; }, 3000);
        }

        function renderAdminTableList() {
            const listEl = document.getElementById('adminTableList');
            const countEl = document.getElementById('adminTableCount');
            if (!listEl) return;
            listEl.innerHTML = '';
            countEl.innerText = tablePositions.length;

            tablePositions.forEach(t => {
                const li = document.createElement('li');
                li.className = 'flex flex-wrap items-center justify-between gap-2 p-2 hover:bg-gray-50 rounded text-sm';
                li.innerHTML = `
                    <span class="font-medium text-gray-800">Bàn ${t.id}</span>
                    <span class="text-gray-500 text-xs">X: ${t.x}% · Y: ${t.y}%</span>
                    <div class="flex gap-1">
                        <button type="button" onclick="editTablePosition(${t.id})" class="text-amber-600 hover:bg-amber-100 px-2 py-1 rounded text-xs font-medium" title="Sửa vị trí">Sửa vị trí</button>
                        <button type="button" onclick="deleteTable(${t.id})" class="text-red-500 hover:bg-red-100 px-2 py-1 rounded text-xs font-medium" title="Xóa bàn">Xóa</button>
                    </div>
                `;
                listEl.appendChild(li);
            });

            if (tablePositions.length === 0) {
                listEl.innerHTML = '<li class="text-gray-400 text-sm text-center py-6 italic">Chưa có bàn nào. Thêm bàn ở form phía trên.</li>';
            }
        }

        function editTablePosition(tableId) {
            const t = tablePositions.find(p => p.id === tableId);
            if (!t) return;
            const xStr = prompt('Vị trí X (%)', t.x);
            if (xStr === null) return;
            const yStr = prompt('Vị trí Y (%)', t.y);
            if (yStr === null) return;
            const xNum = parseInt(xStr, 10);
            const yNum = parseInt(yStr, 10);
            if (isNaN(xNum) || isNaN(yNum)) {
                alert('Vui lòng nhập số hợp lệ.');
                return;
            }
            t.x = Math.max(0, Math.min(100, xNum));
            t.y = Math.max(0, Math.min(100, yNum));
            saveTablePositions();
            renderTables();
            renderMapEdit();
            renderAdminTableList();
            const msgEl = document.getElementById('saveMsg');
            msgEl.innerText = 'Đã cập nhật vị trí bàn ' + tableId + '.';
            setTimeout(() => { msgEl.innerText = ''; }, 3000);
        }

        function deleteTable(tableId) {
            const hasGuests = guests.some(g => String(g.table).includes(String(tableId)));
            if (hasGuests && !confirm('Có khách đang được xếp vào bàn ' + tableId + '. Xóa bàn này vẫn tiếp tục?')) return;
            if (!confirm('Xóa bàn số ' + tableId + ' khỏi sơ đồ?')) return;
            tablePositions = tablePositions.filter(p => p.id !== tableId);
            saveTablePositions();
            renderTables();
            renderMapEdit();
            renderAdminTableList();
            const msgEl = document.getElementById('saveMsg');
            msgEl.innerText = 'Đã xóa bàn ' + tableId + '.';
            setTimeout(() => { msgEl.innerText = ''; }, 3000);
        }

        function resetTablePositions() {
            if (!confirm('Khôi phục lại 45 bàn mặc định? Sơ đồ tùy chỉnh hiện tại sẽ bị thay thế.')) return;
            tablePositions = [...defaultTablePositions];
            saveTablePositions();
            renderTables();
            renderMapEdit();
            renderAdminTableList();
            const msgEl = document.getElementById('saveMsg');
            msgEl.innerText = 'Đã khôi phục 45 bàn mặc định.';
            setTimeout(() => { msgEl.innerText = ''; }, 3000);
        }

        function saveDataToLocal(msg) {
            localStorage.setItem('weddingGuests', JSON.stringify(guests));
            if (useFirebase) {
                saveGuestsToFirebase();
                if (msg) msg += ' Đã đồng bộ lên cloud.';
            }
            var msgEl = document.getElementById('saveMsg');
            if (msgEl) {
                msgEl.innerText = msg || '';
                setTimeout(function() { msgEl.innerText = ''; }, 3000);
            }
        }

        // ================= Xử lý dữ liệu Paste hàng loạt (Có dấu | hoặc Tab) =================
        function parsePastedData() {
            const text = textarea.value.trim();
            if(!text) {
                alert("Vui lòng nhập dữ liệu!"); return;
            }

            const rows = text.split('\n');
            let newGuests = [];
            let errorCount = 0;

            rows.forEach((row, index) => {
                if(!row.trim()) return; // Bỏ qua dòng trống
                // Tách cột bằng dấu | hoặc dấu Tab (để hỗ trợ cả 2 cách copy)
                const cols = row.split(/\||\t/).map(c => c.trim()); 
                
                if(cols.length >= 3) {
                    const name = cols[0];
                    const table = cols[1]; // Giữ nguyên dạng chuỗi để hỗ trợ đa bàn
                    const group = cols[2];
                    
                    // Kiểm tra xem cột bàn có chứa ít nhất 1 chữ số nào không
                    const hasNumber = /\d/.test(table);
                    
                    if(name && hasNumber && group) {
                        const tableCheck = validateTableIds(table);
                        if (tableCheck.valid) {
                            newGuests.push({ id: generateId(), name, table, group });
                        } else {
                            errorCount++;
                        }
                    } else {
                        errorCount++;
                    }
                } else {
                    errorCount++;
                }
            });

            if (newGuests.length > 0) {
                guests = newGuests;
                saveDataToLocal(`Đã lưu thành công ${newGuests.length} khách! (${errorCount} dòng lỗi)`);
                
                // Cập nhật lại UI nếu đang mở
                if(!step2.classList.contains('hidden')) renderGuestList(searchInput.value);
                if(!document.getElementById('tabContentByTable').classList.contains('hidden')) renderAdminAllGuests();
                
                setTimeout(() => { closeSettings(); }, 2000);
            } else {
                alert("Không nhận diện được dữ liệu. Vui lòng đảm bảo bạn copy đúng 3 cột (Tên | Bàn | Nhóm) từ Excel.");
            }
        }

        function resetDefaultData() {
            if(confirm("Bạn có chắc muốn xóa dữ liệu hiện tại và khôi phục dữ liệu mẫu?")) {
                localStorage.removeItem('weddingGuests');
                initMockData();
                if (useFirebase) saveGuestsToFirebase();
                openSettings(); // Tải lại textbox
                document.getElementById('saveMsg').innerText = "Đã khôi phục dữ liệu mẫu.";
            }
        }

        /** Xóa toàn bộ khách, chỉ giữ lại sơ đồ bàn (localStorage + Firebase) */
        function clearGuestsKeepTables() {
            if (!confirm("Xóa toàn bộ danh sách khách? Sơ đồ bàn sẽ được giữ nguyên.")) return;
            guests = [];
            localStorage.setItem('weddingGuests', JSON.stringify(guests));
            if (useFirebase) saveGuestsToFirebase();
            renderAdminAllGuests();
            if (!step2.classList.contains('hidden')) renderGuestList(searchInput.value);
            var msgEl = document.getElementById('saveMsg');
            if (msgEl) {
                msgEl.innerText = 'Đã xóa toàn bộ khách. Sơ đồ bàn vẫn giữ nguyên.';
                setTimeout(function() { msgEl.innerText = ''; }, 4000);
            }
        }

        // Khởi chạy
        function createGoldDust() {
            var container = document.getElementById('dust-container');
            if (!container) return;
            var particleCount = 40;
            for (var i = 0; i < particleCount; i++) {
                var particle = document.createElement('div');
                particle.classList.add('gold-dust');
                var size = Math.random() * 3 + 2;
                var left = Math.random() * 100;
                var duration = Math.random() * 10 + 12;
                var delay = Math.random() * 10;
                var drift = (Math.random() - 0.5) * 80;
                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                particle.style.left = left + '%';
                particle.style.setProperty('--duration', duration + 's');
                particle.style.setProperty('--delay', delay + 's');
                particle.style.setProperty('--drift', drift + 'px');
                container.appendChild(particle);
            }
        }

        window.onload = function() {
            createGoldDust();
            loadTablePositions();
            loadData();
            if (useFirebase) {
                loadFromFirebase().then(function() {
                    renderTables();
                }).catch(function() {
                    renderTables();
                });
            } else {
                renderTables();
            }
        };

    </script>
</body>
</html>